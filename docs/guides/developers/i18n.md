# i18n Developer Guide

This guide covers the technical implementation of internationalization (i18n) in the conversation framework. For the writer-focused localization workflow, see the [Localization Guide](../writers/localization.md).

## i18n API Reference

### getName()

Retrieve localized character/entity names:

```javascript
import { i18n } from './i18n.js';

// Get localized name variant
const name = i18n.getName('activist', 'first_name');  // → "Maria"
const company = i18n.getName('aricanga', 'short');    // → "Aricanga"
```

**Lookup Order:**
1. Locale-specific override (`strings.names[id][variant]`)
2. Base config name (`strings.baseNames[id][variant]`)
3. Fallback: returns the ID itself

### t() - String Lookup

```javascript
import { i18n } from '../i18n.js';

// Simple lookup
const label = i18n.t('hub.pinned');  // → "Pinned" or "Épinglés"

// With interpolation
const status = i18n.t('status.last_seen', { time: '9:23' });
// → "last seen 9:23" or "vu à 9h23"
```

## Component Integration

### Basic Pattern

```javascript
render() {
  this.shadowRoot.innerHTML = `
    <div class="header">${i18n.t('hub.pinned')}</div>
    <span aria-label="${i18n.t('a11y.back_to_chat_list')}">←</span>
  `;
}
```

### Locale Switching

Locale changes load strings dynamically without a page reload:

```javascript
// In settings-page.js
await i18n.setLocale('fr');  // Loads fr.json, emits LOCALE_CHANGED event
```

Components listen for the `LOCALE_CHANGED` event and re-render with new strings.

The saved locale is persisted in `localStorage` under `cc-locale`.

## Translation CLI Internals

This section documents the technical implementation of the translation system.

### LLM Translation Architecture

The `translate` command uses AI providers to translate strings automatically:

```bash
# Translate to French using Google Gemini
export GOOGLE_GENERATIVE_AI_API_KEY=your-key
node experiences/aricanga/utils/translation/cli.js translate -l fr -p google

# Use Anthropic Claude
export ANTHROPIC_API_KEY=your-key
node experiences/aricanga/utils/translation/cli.js translate -l fr -p anthropic

# Use OpenAI
export OPENAI_API_KEY=your-key
node experiences/aricanga/utils/translation/cli.js translate -l fr -p openai

# Preview without calling API
node experiences/aricanga/utils/translation/cli.js translate -l fr --dry-run
```

**Available providers:** `anthropic`, `google`, `openai`, `fake` (for testing)

Provider configuration (default models) is stored in `experiences/aricanga/utils/translation/llm-providers.toml`.

### Structured Outputs

Instead of parsing free-form LLM responses, the system uses the Vercel AI SDK's `generateObject` with a Zod schema. This guarantees valid JSON output and eliminates parsing failures.

### Validation System

The `validate` command checks:

| Check | Description |
|-------|-------------|
| Placeholder preservation | `{name}`, `{count}` must appear in translation |
| Learning marker preservation | `((text::source))` markers must be intact |
| Length constraints | UI strings must fit within `maxLength` limits |
| Empty translations | Source with content shouldn't have empty translation |

**Error Types:**

| Error | Cause | Fix |
|-------|-------|-----|
| `missing_placeholder` | `{var}` not in translation | Re-translate or manually add |
| `extra_placeholder` | Translation has `{var}` not in source | Remove spurious placeholder |
| `missing_marker` | `((text::source))` not preserved | Re-translate |
| `empty_translation` | Non-empty source got empty translation | Re-translate |
| `exceeds_maxLength` | UI string too long | Shorten translation |

### Output Formats

The extract command supports three formats:

**Prompt Format** (default) - For LLM/manual translation:
```bash
mise run tl -l fr -f prompt
```

**JSON Format** - For API integration:
```bash
mise run tl -l fr -f json -o fr.json
```

**XLIFF Format** - For Crowdin (experimental):
```bash
mise run tl -l fr -f xliff -o fr.xliff
```

### Locale Rules Files

Create `experiences/{impl}/data/locales/{locale}-rules.toml` to define locale-specific behavior:

```toml
# fr-rules.toml
[typography]
quote_open = "«\u00A0"      # French guillemets with non-breaking space
quote_close = "\u00A0»"

[formatting]
time_format = "HH\\hmm"     # 14h30 instead of 2:30 PM
date_format = "d MMMM"      # 14 janvier
```

### State Tracking

The CLI maintains translation state in `experiences/{impl}/.translation-state/{locale}.json`:

```json
{
  "locale": "fr",
  "lastExtracted": "2024-01-15T10:30:00Z",
  "itemsTranslated": 156,
  "itemsPending": 12,
  "coverage": {
    "config": 1.0,
    "ink": 0.92
  }
}
```

### Iterative Translation Workflow

For partial translations or updates:

```bash
# Extract only untranslated items
mise run tl -l fr --pending-only

# Extract specific content types
mise run tl -l fr --scope ink        # Only ink files
mise run tl -l fr --scope config     # Only config strings

# Retry failed batches
node experiences/aricanga/utils/translation/cli.js translate -l es -p anthropic --scope ink
```

## RTL Language Considerations

This section documents what would be needed to support right-to-left (RTL) languages like Arabic or Hebrew. **RTL is not currently implemented** - this is research documentation for future reference.

### CSS Patterns Requiring RTL Adaptation

| Pattern | Current | RTL Change Needed |
|---------|---------|-------------------|
| `text-align: left` | Hardcoded left | Use `start` or conditional |
| `text-align: right` | Hardcoded right | Use `end` or conditional |
| `flex-direction` with `flex-start/flex-end` | Used for sent/received alignment | Swap or use logical properties |
| `margin-left`, `padding-left` | Physical direction | Use `margin-inline-start` |
| `margin-right`, `padding-right` | Physical direction | Use `margin-inline-end` |
| Back button `‹` | Points left | Mirror to `›` for RTL |

### Message Bubble Alignment

Sent messages appear on the right, received on the left. In RTL:
- Sent messages should appear on the **left**
- Received messages should appear on the **right**

Current implementation uses `justify-content: flex-end` for sent messages - this would need to use `start` in RTL context.

### Components Requiring Updates

1. **chat-thread.js**
   - Message bubble alignment (`.sent { justify-content: flex-end }`)
   - Back button icon direction
   - Input field text alignment

2. **chat-hub.js**
   - Chat list item layout
   - Unread badge position
   - Avatar positioning

3. **notification-popup.js**
   - Dismiss button position (`right: 8px`)
   - Content alignment

4. **phone-status-bar.js**
   - Clock and battery icon positions

### Implementation Approaches

**Option A: CSS Logical Properties**
```css
/* Instead of */
.bubble { margin-left: 20px; }
/* Use */
.bubble { margin-inline-start: 20px; }
```

**Option B: RTL Stylesheet Override**
```css
[dir="rtl"] .bubble.sent { justify-content: flex-start; }
[dir="rtl"] .back-button { transform: scaleX(-1); }
```

**Option C: CSS Custom Properties with Direction Awareness**
```css
:root { --direction-start: left; --direction-end: right; }
[dir="rtl"] { --direction-start: right; --direction-end: left; }
.bubble { text-align: var(--direction-start); }
```

### Estimated Effort

| Task | Effort |
|------|--------|
| Add `dir` attribute handling to root | Small |
| Update CSS to use logical properties | Medium |
| Test and fix alignment issues | Medium |
| Icon mirroring for directional icons | Small |
| **Total** | **Medium** |

### References

- [CSS Logical Properties - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Logical_Properties)
- [RTL Styling 101 - Ahmad Shadeed](https://rtlstyling.com/)
